---
title: "Test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load data and clean names 
Treat <NULL> and UNKNOWN as missing
```{r}
setwd("S:/Indiana Research & Evaluation/Matthew Hanauer/CTS_grant_docs/Otsuka/data")
#non_tn_schiz_dat = read.csv("CIN_CIL_CFL_schz_dat_9_16_20.csv", header = TRUE, na.strings = c("<NULL>", "UNKNOWN))
### Need Client.ID, Admission.Last.Service.Date, Service.Location.County, Diagnosis.Type.Diagnosis.Description, Client.Intake.Referrals.Client.Age, Gender.Gender, Race.Type.Race.Type
non_tn_schiz_data = non_tn_schiz_dat[c("Client.ID", "Service.Date", "Service.Location.County", "Client.Diagnosis.Diagnosis.Description", "Service.Age.at.Service", "Gender.Gender", "Race.Type.Race.Type", "Organization.Master.Organization.Headquarters.State.Abbreviation", "Client.Diagnosis.Ranking.Code", "Client.Diagnosis.Diagnosis.Type.Code")]
non_tn_schiz_data

names(non_tn_schiz_data) = c("client_id", "admin_date", "county", "diagnosis", "age", "gender", "race", "state", "diagnosis_ranking", "diag_type_code")
library(prettyR)
# Check for variables outside of reasonable range
#apply(non_tn_schiz_data[,2:9], 2, function(x){describe.factor(x)})
```
Subset by 18 and older and between  May 1, 2019 and August 2020
Don't have May 1 2019 starting at July 1 2019
Remove remaining NAs
Only include those at admission
```{r}
#This removes the NAs for Age
non_tn_schiz_data = subset(non_tn_schiz_data, age > 17)
sum(non_tn_schiz_data$age < 18)
describe.factor(non_tn_schiz_data$age)
dim(non_tn_schiz_data)
library(lubridate)
non_tn_schiz_data$admin_date = mdy(non_tn_schiz_data$admin_date)
non_tn_schiz_data$admin_date = floor_date(non_tn_schiz_data$admin_date, unit = c("month"))
non_tn_schiz_data = subset(non_tn_schiz_data, admin_date >= "2019-05-01" & admin_date <= "2020-08-31")
sum(non_tn_schiz_data$admin_date < "2019-05-01" | non_tn_schiz_data$admin_date > "2020-08-31")

non_tn_schiz_data = subset(non_tn_schiz_data, diag_type_code == "A")
dim(non_tn_schiz_data)
```
Need one record by client with the primary diagnosis OR the diagnosis that trumps “unspecified”
For duplicates identified those with the first ID as unspecified
Assuming duplicate diagnoses are repeats need to check this assumption and try to find secondary and third diag
```{r}
library(dplyr)
non_tn_schiz_data$dup_var =  duplicated(non_tn_schiz_data$client_id)
non_tn_schiz_data
# sort by id
non_tn_schiz_data = non_tn_schiz_data[order(non_tn_schiz_data$client_id),]
# Shows that code below works
#vec <- c("a", "b", "c","c","c")
#vec =  vec %in% unique(vec[ duplicated(vec)]) 
#vec
non_tn_schiz_data$dup_var_all =  non_tn_schiz_data$client_id %in% unique(non_tn_schiz_data$client_id[duplicated(non_tn_schiz_data$client_id)])
non_tn_schiz_data$first_dup = ifelse(non_tn_schiz_data$dup_var == FALSE & non_tn_schiz_data$dup_var_all == TRUE, 1, 0)
non_tn_schiz_data$uspec_first_dup
### Check that are no more than 2 duplicates
count_id =  non_tn_schiz_data %>% count(client_id)
# There are up to six instances / diagnosis per client
describe.factor(count_id$n)

```
Get diagnosis descriptions
```{r}
describe.factor(non_tn_schiz_data$diagnosis)
```

1. Get non-first duplicate id and unspecified
2. Drop those who have non-first duplicate id and unspecified
3. Get first duplicate id and unspecified
4. Drop those who have first duplicate id and unspecifed
5. Drop remaining duplicates leaving you with highest diagnosis level that is not unspecified
```{r}
describe.factor(non_tn_schiz_data$diagnosis)
non_tn_schiz_data$dup_diag_not_unspec = ifelse(non_tn_schiz_data$dup_var_all == 1 & non_tn_schiz_data$diagnosis == "UNSPECIFIED SCHIZOPHRENIA SPECTRUM AND OTHER PSYCHOTIC DISORDER", 1, 0)
non_tn_schiz_data$non_first_dup_and_unspec = ifelse(non_tn_schiz_data$dup_var == TRUE & non_tn_schiz_data$diagnosis == "UNSPECIFIED SCHIZOPHRENIA SPECTRUM AND OTHER PSYCHOTIC DISORDER", 1, 0)
non_tn_schiz_data = subset(non_tn_schiz_data, non_first_dup_and_unspec == 0)
non_tn_schiz_data$first_dup_unspec = ifelse(non_tn_schiz_data$first_dup == TRUE & non_tn_schiz_data$diagnosis == "UNSPECIFIED SCHIZOPHRENIA SPECTRUM AND OTHER PSYCHOTIC DISORDER", 1, 0)
### EVen though no instances just drop in case you load in data later with repeats
non_tn_schiz_data = subset(non_tn_schiz_data, first_dup_unspec == 0)
### Keep highest level of diagnosis that is not unspecified
non_tn_schiz_data = subset(non_tn_schiz_data, dup_var == FALSE)
n = dim(non_tn_schiz_data)[1]
non_tn_schiz_data$admin_date = floor_date(non_tn_schiz_data$admin_date, unit = c("month"))
non_tn_schiz_data = non_tn_schiz_data[,c(1:7)]
non_tn_schiz_data$schz = rep(1, dim(non_tn_schiz_data)[1])
```
Table by diagnosis
```{r}
count_diag = non_tn_schiz_data %>% count(diagnosis)
count_diag = count_diag[order(count_diag$n, decreasing = TRUE),]
count_diag
```
Table by month for all diagnoses
Need to get the number of clients served per year, but even with that this is a very large spike

```{r}

count_month = non_tn_schiz_data %>% group_by(admin_date) %>% count(schz)
count_month$percentage_pop = round(count_month$n / n,2)*100
count_month
```
Table by county by four month period
We want the count by four month period (May 2019 to Aug 2019) and compare to same period 2020 by county and state
Start with county then get state
```{r}
n = dim(non_tn_schiz_data)[1]
# Create the two four month indicators May_2019_Aug_2019 and May_2020_Aug_2020
non_tn_schiz_data$month_indicator = ifelse(non_tn_schiz_data$admin_date >= "2019-05-01" & non_tn_schiz_data$admin_date <= "2019-08-01", "May_2019_Aug_2019", ifelse(non_tn_schiz_data$admin_date >= "2020-05-01" & non_tn_schiz_data$admin_date <= "2020-08-01",  "May_2020_Aug_2020", "Wrong"))
count_county = subset(non_tn_schiz_data,month_indicator != "Wrong")
library(tidyverse)
## Need this plus .drop = FALSE to include counting zeros
count_county <- count_county %>% modify_if(is.character, as.factor)
count_county
count_county = count_county %>% group_by(county, month_indicator) %>%  count(schz, .drop = FALSE)
count_county
May_2019_Aug_2019 = subset(count_county, month_indicator == "May_2019_Aug_2019")
May_2020_Aug_2020 = subset(count_county, month_indicator == "May_2020_Aug_2020") 
count_county = data.frame(county = May_2019_Aug_2019$county, May_2019_Aug_2019 = May_2019_Aug_2019$n , May_2020_Aug_2020 = May_2020_Aug_2020$n)
count_county
```
Monthly count of all diagnosis by count
```{r}
month_by_diag_fun = function(data){

data$month_indicator = ifelse(data$admin_date >= "2019-05-01" & data$admin_date <= "2019-08-01", "May_2019_Aug_2019", ifelse(data$admin_date >= "2020-05-01" & data$admin_date <= "2020-08-01",  "May_2020_Aug_2020", "Wrong"))
count_county = subset(data,month_indicator != "Wrong")
count_county$month_indicator = NULL
count_county <- count_county %>% modify_if(is.character, as.factor)
count_county = count_county %>% group_by(admin_date, county) %>%  count(schz, .drop = FALSE)
count_county$schz = NULL
# Add back later "2019-05-01", "2019-06-01",
month_list = list("2019-07-01", "2019-08-01", "2020-05-01", "2020-06-01", "2020-07-01", "2020-08-01")
out_list = list() 
county = list()
for(i in 1:length(month_list)){
  out_list[[i]] = subset(count_county, admin_date == month_list[[i]])
  out_list[[i]]$admin_date = NULL
  county[[i]] =  out_list[[1]]$county
  out_list[[i]]$county = NULL
}
out_list = data.frame(out_list)
names(out_list) = c("Jul 2019", "Aug 2019", "May 2020", "June 2020", "July 2020", "Aug 2020")
county = data.frame(county = county)
names(county) = "county"
out_list = cbind(county = county, out_list)
return(out_list)
}
month_by_diag_fun(non_tn_schiz_data)
```
Function above replicates
```{r}
non_tn_schiz_data$month_indicator = ifelse(non_tn_schiz_data$admin_date >= "2019-05-01" & non_tn_schiz_data$admin_date <= "2019-08-01", "May_2019_Aug_2019", ifelse(non_tn_schiz_data$admin_date >= "2020-05-01" & non_tn_schiz_data$admin_date <= "2020-08-01",  "May_2020_Aug_2020", "Wrong"))
count_county = subset(non_tn_schiz_data,month_indicator != "Wrong")
count_county$month_indicator = NULL
count_county <- count_county %>% modify_if(is.character, as.factor)
count_county = count_county %>% group_by(admin_date, county) %>%  count(schz, .drop = FALSE)
count_county$schz = NULL
# Add back later "2019-05-01", "2019-06-01",
month_list = list("2019-07-01", "2019-08-01", "2020-05-01", "2020-06-01", "2020-07-01", "2020-08-01")
out_list = list() 
county = list()
for(i in 1:length(month_list)){
  out_list[[i]] = subset(count_county, admin_date == month_list[[i]])
  out_list[[i]]$admin_date = NULL
  county[[i]] =  out_list[[1]]$county
  out_list[[i]]$county = NULL
}
out_list = data.frame(out_list)
names(out_list) = c("Jul 2019", "Aug 2019", "May 2020", "June 2020", "July 2020", "Aug 2020")
county = data.frame(county = county)
names(county) = "county"
out_list = cbind(county = county, out_list)
out_list

```

```{r}
count_diag
```

Now just SCHIZOAFFECTIVE 
```{r}
dat_SCHIZOAFFECTIVE = non_tn_schiz_data
dat_SCHIZOAFFECTIVE$SCHIZOAFFECTIVE =  grepl("SCHIZOAFFECTIVE", dat_SCHIZOAFFECTIVE$diagnosis)
dat_SCHIZOAFFECTIVE = subset(dat_SCHIZOAFFECTIVE, SCHIZOAFFECTIVE == TRUE)
dat_SCHIZOAFFECTIVE
month_by_diag_fun(dat_SCHIZOAFFECTIVE)
```
Now just SCHIZOPHRENIA 
```{r}
dat_SCHIZOPHRENIA  = non_tn_schiz_data
dat_SCHIZOPHRENIA$SCHIZOPHRENIA =  grepl("SCHIZOPHRENIA", dat_SCHIZOPHRENIA$diagnosis)
dat_SCHIZOPHRENIA = subset(dat_SCHIZOPHRENIA, SCHIZOPHRENIA == TRUE)
month_by_diag_fun(dat_SCHIZOPHRENIA)
```
Now get all others
```{r}
dat_other  = non_tn_schiz_data
dat_other$SCHIZOPHRENIA =  grepl("SCHIZOPHRENIA", dat_other$diagnosis)
dat_other$SCHIZOAFFECTIVE =  grepl("SCHIZOAFFECTIVE", dat_other$diagnosis)
dat_other = subset(dat_other, SCHIZOPHRENIA == FALSE & SCHIZOAFFECTIVE == FALSE)
dat_other
month_by_diag_fun(dat_other)

```

